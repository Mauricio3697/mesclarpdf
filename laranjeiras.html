<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Declaração de Comparecimento — Formal</title>
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --blue:#0f4a7a;
      --muted:#666;
      --paper:#fff;
      --page-width:21cm;
      --page-height:29.7cm;
      --base-font:18px;
    }
    html,body{height:100%;margin:0;background:#f3f6f9;font-family:'Lato',system-ui,Arial;color:#222}
    .sheet{
      width:var(--page-width);
      min-height:var(--page-height);
      margin:20px auto;
      background:var(--paper);
      padding:26mm 22mm 26mm 22mm;
      box-shadow:0 6px 18px rgba(0,0,0,0.06);
      position:relative;
      box-sizing:border-box;
      font-size:var(--base-font);
      line-height:1.65;
      color:#222;
      z-index:1;
      border: 1px solid #ddd;
    }
    .header{display:flex;align-items:center;justify-content:space-between;border-bottom:4px solid var(--blue);padding-bottom:10px}
    .logo-small{height:72px;object-fit:contain}
    .govtext{flex:1;text-align:center;padding-left:10px}
    .govtext h1{margin:0;font-size:16px;font-weight:800;letter-spacing:0.6px}
    .govtext p{margin:0;font-size:13px;color:var(--muted)}
    .title{font-size:36px;text-align:center;color:var(--blue);font-weight:900;margin:28px 0 18px;text-transform:uppercase;letter-spacing:1.6px}
    .body{font-size:20px;color:#111}
    .body p{margin:0 0 14px}
    .body .strong{font-weight:800;color:#000}
    .cid{margin-top:14px;font-weight:700;color:var(--muted);font-size:16px}
    .cid .code{font-weight:900;color:#000;margin-right:8px}
    .cid .desc{font-weight:600}
    .cid small{display:block;color:var(--muted);font-weight:400;margin-top:6px}
    .watermark {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%,-50%);
      width: 60%;
      max-width: 680px;
      opacity: 0.0;
      pointer-events: none;
      z-index: 0;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }
    .watermark-text {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: 42mm;
      font-size: 13px;
      color: rgba(0,0,0,0.24);
      font-weight: 700;
      text-align: center;
      z-index: 0;
      pointer-events: none;
      white-space: pre-line;
    }
    .signature-area{
      position:absolute;
      left:50%;
      top:56%;
      transform:translate(-50%,-50%);
      text-align:center;
      width:52%;
      max-width:460px;
      z-index:2;
    }
    .signature-line{height:92px;border-bottom:1px solid #000;margin-bottom:8px}
    .signature-name{font-weight:900;font-size:16px;position:relative;z-index:3}
    .signature-role{font-size:13px;color:var(--muted);position:relative;z-index:3}
    .stamp {
      position: absolute;
      top: -34px;
      left: 50%;
      transform: translateX(-50%) rotate(-8deg);
      width: 160px;
      opacity: 0.88;
      mix-blend-mode: multiply;
      pointer-events: none;
      z-index:2;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }
    .footer{position:absolute;left:22mm;bottom:18mm;font-size:14px;color:var(--muted);width:calc(var(--page-width) - 44mm);box-sizing:border-box;text-align:left;border-top:1px solid #eee;padding-top:6px}
    .auth-inline{float:right;font-weight:700;color:#333}
    .controls{display:flex;flex-direction:column;gap:12px;padding:16px;background:#fff;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,0.06);max-width:21cm;margin:8px auto}
    .controls h3 { margin: 0 0 8px 0; font-size: 16px; color: var(--blue); border-bottom: 2px solid #eee; padding-bottom: 6px; }
    .controls label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    .controls input,.controls select{padding:8px;border:1px solid #ddd;border-radius:4px;font-size:15px; width: 100%; box-sizing: border-box;}
    .controls .row{display:flex;gap:12px; align-items: flex-end;}
    .controls .row > *{flex:1}
    .controls .full-width { flex-basis: 100%; }
    .muted-note{font-size:13px;color:var(--muted)}
    .btn{padding:10px 14px;border-radius:6px;border:0;color:#fff;font-weight:700;cursor:pointer; width: 100%;}
    .btn-print{background:#2f9f4a}

    .formal-border {
        position: absolute;
        top: 10mm; left: 10mm; right: 10mm; bottom: 10mm;
        border: 2px solid var(--blue);
        pointer-events: none;
        box-sizing: border-box;
        z-index: 0;
    }
    
    /* --- NOVOS ESTILOS: MENSAGEM COM DIGITAÇÃO NO PAINEL --- */
    .feedback-container {
        min-height: 40px; /* Previne que o layout salte */
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .feedback-container p {
        display: inline-block;
        margin: 0;
        padding: 8px 12px;
        border-radius: 6px;
        font-weight: 700;
        overflow: hidden;
        border-right: .15em solid; /* Cursor */
        white-space: nowrap;
        vertical-align: middle;
        max-width: 100%;
    }
    .feedback-container p.success {
        background: #d4edda;
        color: #155724;
        border-color: #155724; /* Cor do cursor */
    }
    .feedback-container p.error {
        background: #f8d7da;
        color: #721c24;
        border-color: #721c24; /* Cor do cursor */
    }
    @keyframes typing { from { width: 0 } to { width: 100% } }
    @keyframes blink-caret { from, to { border-color: transparent } 50% { border-color: inherit; } }


    @media print{
      body{background:transparent}
      .sheet{
        box-shadow:none; margin:0; padding:18mm; border-radius:0; border: none; zoom: 95%;
      }
      .formal-border {
        top: 0mm; left: 0mm; right: 0mm; bottom: 0mm; border: 2mm solid var(--blue); position: fixed;
      }
      .controls {display:none}
      @page{size:A4;margin:0mm;}
      .watermark { opacity: 0.10 !important; width: 66% !important; filter: grayscale(100%) contrast(110%) !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
      .watermark-text { color: rgba(0,0,0,0.34) !important; font-size: 12px !important; }
      .stamp { mix-blend-mode: normal !important; filter: grayscale(100%) contrast(130%) brightness(95%) !important; opacity: 0.98 !important; width: 34% !important; left: 50%; transform: translateX(-50%) rotate(-8deg); z-index:2; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
      .signature-name, .signature-role { z-index:3 !important; position:relative !important; }
      img { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
    }
  </style>
</head>
<body>
  
  <div class="sheet" id="doc">
    <div class="formal-border"></div>
    <img class="watermark" src="https://i.imgur.com/fIO428k.png" alt="Marca d'água oficial" crossorigin="anonymous" />
    <div class="watermark-text">
      CNES: 2085879 · AVENIDA PAULICÉIA 360 · (11) 4899-3367
      <br>PARA CONFIRMAR AUTENTICIDADE
    </div>
    <div class="header">
      <div class="left"><img class="logo-small" id="logo-left" src="https://i.imgur.com/v7MHC4w.png" alt="Brasão Prefeitura"></div>
      <div class="govtext">
        <h1>PREFEITURA DE CAIEIRAS<br>SECRETARIA MUNICIPAL DA SAÚDE</h1>
        <p>UNIDADE BÁSICA DE SAÚDE — UBS LARANJEIRAS</p>
      </div>
      <div class="right"><img class="logo-small" id="logo-right" src="https://i.imgur.com/A1eWZK0.png" alt="SUS"></div>
    </div>
    <div class="title">Declaração de Comparecimento</div>
    <div class="body" id="body-text">
      <p>Declaramos, para os devidos fins, que <span class="strong" id="ex-paciente">NOME COMPLETO DO(A) PACIENTE</span>, portador(a) do CPF nº <span class="strong" id="ex-cpf">000.000.000-00</span>, compareceu à <span class="strong" id="ex-unidade">UBS Laranjeiras</span>, na data de <span class="strong" id="ex-data">DD/MM/AAAA</span>, no período compreendido entre <span class="strong" id="ex-hora-inicio">hh:mm</span> e <span class="strong" id="ex-hora-fim">hh:mm</span>, para a realização de <span class="strong" id="ex-procedimento">procedimento</span>.</p>
      <p class="cid">CID: <span class="code" id="ex-cid">---</span> <span class="desc" id="ex-cid-desc">Descrição detalhada do procedimento / motivo</span>
        <small>OBS.: Verificado e registrado o CID conforme documentação clínica e tabela oficial vigente.</small>
      </p>
    </div>
    <div class="signature-area" id="signature-area">
      <div class="signature-line" id="signature-line"></div>
      <div class="signature-name" id="sig-name">NOME DO PROFISSIONAL</div>
      <div class="signature-role" id="sig-role">UBS Laranjeiras</div>
      <img id="stamp-img" src="https://i.imgur.com/lLAQqeK.png" alt="Carimbo Oficial" class="stamp" crossorigin="anonymous">
    </div>
    <div class="footer">
      Caieiras - SP, <span id="footer-date">DD de mês de AAAA</span>
      <span class="auth-inline">ID DE AUTENTICAÇÃO: <strong id="auth-id-value">—</strong></span>
    </div>
  </div>

  <div class="controls no-print" aria-hidden="false">
    <h3>Dados do Paciente</h3>
    <div class="row">
      <div>
        <label for="input-nome">Nome Completo</label>
        <input type="text" id="input-nome" value="Paciente Silva" />
      </div>
      <div>
        <label for="input-cpf">CPF</label>
        <input type="text" id="input-cpf" value="123.456.789-00" maxlength="14" />
      </div>
    </div>

    <h3>Detalhes do Atendimento</h3>
    <div class="row">
      <div class="full-width">
          <label for="input-procedimento">Procedimento / Motivo</label>
          <select id="input-procedimento"></select>
      </div>
    </div>
     <div class="row">
        <div class="full-width">
            <label for="input-profissional">Profissional Responsável</label>
            <select id="input-profissional"></select>
        </div>
    </div>
    <div class="row">
      <div>
        <label for="input-data">Data</label>
        <input type="date" id="input-data" />
      </div>
      <div>
        <label for="input-hora-inicio">Início</label>
        <input type="time" id="input-hora-inicio" />
      </div>
      <div>
        <label for="input-hora-fim">Término</label>
        <input type="time" id="input-hora-fim" />
      </div>
    </div>

    <h3>Finalização</h3>
    <div id="feedback-container" class="feedback-container"></div>
    <div class="row">
        <button id="regprint" class="btn btn-print">Registrar e Imprimir</button>
    </div>
    <div class="muted-note" style="text-align: center;">A atualização do documento é feita em tempo real.</div>
  </div>

<script>
/* ============================ CONFIGURAÇÃO ================================ */
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwyAyqmZlfLVRR8dgjqHTWl_jGYfAID3F_cTqrDsbLkkXDJusdPz9mdXswyzQZP1ejH/exec';

const PROFISSIONAIS = [
    { nome: "Adriana Maria", carimboUrl: "https://i.imgur.com/HrmcNkI.png" },
    { nome: "Mauricio Matheus Dias Oliveira", carimboUrl: "https://i.imgur.com/lLAQqeK.png", selecionado: true }
];

const PROCEDIMENTOS = [
    { texto: "Consulta geral", valor: "Consulta médica geral", cid: "Z00.0", desc: "Exame clínico de rotina / avaliação médica" },
    { texto: "Consulta psicológica", valor: "Consulta psicológica", cid: "Z71.9", desc: "Aconselhamento não especificado" },
    { texto: "Troca de receita", valor: "Comparecimento para troca de receita", cid: "Z76.0", desc: "Emissão de prescrição de repetição" },
    { texto: "Exame de sangue", valor: "Exame laboratorial de sangue", cid: "Z01.0", desc: "Exame laboratorial de rotina ('Check up')" },
    { texto: "Vacinação", valor: "Vacinação", cid: "Z23", desc: "Vacinação profilática" }
];

const FRASES_DE_ELOGIO = [
    "Excelente trabalho, {nome}!",
    "Serviço impecável, {nome}!",
    "Mais um ótimo atendimento, {nome}!",
    "Parabéns pelo profissionalismo, {nome}!",
    "Eficiência e qualidade, parabéns {nome}!"
];
/* ========================================================================= */

/* Seleção de Elementos do DOM */
const inputNome = document.getElementById('input-nome');
const inputCpf = document.getElementById('input-cpf');
const inputProc = document.getElementById('input-procedimento');
const inputProf = document.getElementById('input-profissional');
const inputData = document.getElementById('input-data');
const inputHoraInicio = document.getElementById('input-hora-inicio');
const inputHoraFim = document.getElementById('input-hora-fim');
const exPaciente = document.getElementById('ex-paciente');
const exCpf = document.getElementById('ex-cpf');
const exData = document.getElementById('ex-data');
const exHoraInicio = document.getElementById('ex-hora-inicio');
const exHoraFim = document.getElementById('ex-hora-fim');
const exProc = document.getElementById('ex-procedimento');
const exCid = document.getElementById('ex-cid');
const exCidDesc = document.getElementById('ex-cid-desc');
const sigName = document.getElementById('sig-name');
const stampImg = document.getElementById('stamp-img');
const footerDate = document.getElementById('footer-date');
const authValueEl = document.getElementById('auth-id-value');
const regPrintBtn = document.getElementById('regprint');
const feedbackContainer = document.getElementById('feedback-container');

let ultimoIdRegistrado = null;
let estaRegistrando = false;

/* --- FUNÇÕES DE FORMATAÇÃO E UTILIDADES --- */
function formatarNome(nome) { return nome.toLowerCase().replace(/(?:^|\s)\S/g, char => char.toUpperCase()); }
function formatarCPF(cpf) {
    let valor = cpf.replace(/\D/g, '');
    valor = valor.replace(/(\d{3})(\d)/, '$1.$2');
    valor = valor.replace(/(\d{3})(\d)/, '$1.$2');
    valor = valor.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
    return valor;
}

// --- NOVA FUNÇÃO showMessage COM DIGITAÇÃO NO PAINEL ---
function showMessage(text, isSuccess = true) {
    feedbackContainer.innerHTML = ''; // Limpa mensagem anterior

    const p = document.createElement('p');
    p.textContent = text;
    p.className = isSuccess ? 'success' : 'error';
    
    const duracaoAnimacao = Math.max(1.5, text.length * 0.05);
    p.style.animation = `typing ${duracaoAnimacao}s steps(${text.length * 2}, end), blink-caret .75s step-end infinite`;
    
    feedbackContainer.appendChild(p);

    setTimeout(() => {
        feedbackContainer.innerHTML = '';
    }, (duracaoAnimacao * 1000) + 4000); // Duração da animação + 4s de leitura
}

const pad = (n) => String(n).padStart(2, '0');
const formatDateLong = (d) => {
  const meses = ['janeiro', 'fevereiro', 'março', 'abril', 'maio', 'junho', 'julho', 'agosto', 'setembro', 'outubro', 'novembro', 'dezembro'];
  return `${d.getDate()} de ${meses[d.getMonth()]} de ${d.getFullYear()}`;
};

function preencherCamposComDataAtual() {
  const agora = new Date();
  if (!inputData.value) inputData.valueAsDate = agora;
  if (!inputHoraInicio.value) inputHoraInicio.value = `${pad(agora.getHours())}:${pad(agora.getMinutes())}`;
  if (!inputHoraFim.value) {
    const maisTarde = new Date(agora.getTime() + 30 * 60000);
    inputHoraFim.value = `${pad(maisTarde.getHours())}:${pad(maisTarde.getMinutes())}`;
  }
}

function popularSeletores() {
    inputProf.innerHTML = '';
    inputProc.innerHTML = '';
    PROFISSIONAIS.forEach(prof => {
        const option = document.createElement('option');
        option.value = prof.nome;
        option.textContent = prof.nome;
        option.dataset.stampUrl = prof.carimboUrl;
        if (prof.selecionado) option.selected = true;
        inputProf.appendChild(option);
    });
    PROCEDIMENTOS.forEach(proc => {
        const option = document.createElement('option');
        option.value = proc.valor;
        option.textContent = proc.texto;
        option.dataset.cid = proc.cid;
        option.dataset.desc = proc.desc;
        inputProc.appendChild(option);
    });
}

function aplicarValores() {
  const nome = inputNome.value.trim() || 'NOME COMPLETO DO(A) PACIENTE';
  const cpf = inputCpf.value.trim() || '000.000.000-00';
  const selectedProcOption = inputProc.selectedOptions[0];
  const procedimento = selectedProcOption ? selectedProcOption.value : 'Procedimento';
  const cid = selectedProcOption ? selectedProcOption.dataset.cid : '---';
  const cidDesc = selectedProcOption ? selectedProcOption.dataset.desc : '';
  const selectedProfOption = inputProf.selectedOptions[0];
  const profissional = selectedProfOption ? selectedProfOption.value : 'NOME DO PROFISSIONAL';
  const carimboUrl = selectedProfOption ? selectedProfOption.dataset.stampUrl : '';
  let dataVal = inputData.value;
  let horaInicioVal = inputHoraInicio.value;
  let horaFimVal = inputHoraFim.value;

  if (!dataVal || !horaInicioVal || !horaFimVal) {
    preencherCamposComDataAtual();
    dataVal = inputData.value;
    horaInicioVal = inputHoraInicio.value;
    horaFimVal = inputHoraFim.value;
  }
  
  exPaciente.textContent = formatarNome(nome);
  exCpf.textContent = cpf;
  const [yyyy, mm, dd] = dataVal.split('-');
  exData.textContent = `${dd}/${mm}/${yyyy}`;
  exHoraInicio.textContent = horaInicioVal;
  exHoraFim.textContent = horaFimVal;
  exProc.textContent = procedimento;
  exCid.textContent = cid;
  exCidDesc.textContent = cidDesc;
  sigName.textContent = profissional;
  stampImg.src = carimboUrl;
  
  footerDate.textContent = formatDateLong(new Date(`${dataVal}T00:00:00`));
}

function gerarIdUnico() {
  const now = new Date();
  const datePart = `${now.getFullYear()}${pad(now.getMonth() + 1)}${pad(now.getDate())}`;
  const timePart = `${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;
  const rndPart = Math.random().toString(36).substring(2, 7).toUpperCase();
  return `UBS-${datePart}${timePart}-${rndPart}`;
}

function coletarDadosParaRegistro(id) {
  const hoje = new Date();
  const selectedProcOption = inputProc.selectedOptions[0];
  return {
    ID: id,
    Nome: inputNome.value.trim(),
    CPF: inputCpf.value.trim(),
    DataAtendimento: inputData.value,
    HorarioAtendimento: `${inputHoraInicio.value} - ${inputHoraFim.value}`,
    TipoAtendimento: selectedProcOption ? selectedProcOption.value : '',
    Justificativa: selectedProcOption ? selectedProcOption.dataset.desc : '',
    Profissional: inputProf.value,
    DataEmissao: hoje.toLocaleDateString('pt-BR'),
    HoraEmissao: hoje.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
  };
}

async function enviarParaPlanilha(dataObj) {
  try {
    await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(dataObj) });
    return { ok: true };
  } catch (error) {
    console.error('Erro ao enviar dados:', error);
    return { ok: false, error };
  }
}

async function registrarDeclaracao(forcarNovo = false) {
  if (estaRegistrando) return null;
  if (ultimoIdRegistrado && !forcarNovo) return ultimoIdRegistrado;
  estaRegistrando = true;
  const id = gerarIdUnico();
  const payload = coletarDadosParaRegistro(id);
  try {
    const res = await enviarParaPlanilha(payload);
    ultimoIdRegistrado = id;
    authValueEl.textContent = id;
    if (res.ok) {
        const nomeProfissional = inputProf.value.split(' ')[0];
        const fraseAleatoria = FRASES_DE_ELOGIO[Math.floor(Math.random() * FRASES_DE_ELOGIO.length)];
        const mensagemElogio = fraseAleatoria.replace('{nome}', nomeProfissional);
        showMessage(mensagemElogio, true);
    } else {
        showMessage(`Falha ao registrar. Tente novamente.`, false);
    }
    return res.ok;
  } finally {
    estaRegistrando = false;
  }
}

function validarCampos() {
  if (!inputNome.value.trim()) {
    showMessage('Preencha o nome do paciente.', false); return false;
  }
  if (inputCpf.value.trim().length < 14) {
    showMessage('Preencha o CPF completo.', false); return false;
  }
  return true;
}

async function acaoRegistrarEImprimir() {
  if (!validarCampos()) return;
  regPrintBtn.disabled = true;
  regPrintBtn.textContent = 'Registrando...';
  aplicarValores();
  const sucesso = await registrarDeclaracao(true);
  
  if (sucesso) {
      setTimeout(() => {
        window.print();
      }, 500);
  }
  
  regPrintBtn.disabled = false;
  regPrintBtn.textContent = 'Registrar e Imprimir';
}

// --- INICIALIZAÇÃO ---
document.addEventListener('DOMContentLoaded', () => {
  popularSeletores();
  regPrintBtn.addEventListener('click', acaoRegistrarEImprimir);
  const inputsParaMonitorar = [inputNome, inputCpf, inputProc, inputProf, inputData, inputHoraInicio, inputHoraFim];
  inputsParaMonitorar.forEach(input => {
      input.addEventListener('input', aplicarValores);
      input.addEventListener('change', aplicarValores);
});
  inputCpf.addEventListener('input', (e) => { e.target.value = formatarCPF(e.target.value); });
  window.addEventListener('beforeprint', aplicarValores);
  preencherCamposComDataAtual();
  aplicarValores();
});
</script>

</body>
</html>
