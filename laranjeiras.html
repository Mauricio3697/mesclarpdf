<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Declaração de Comparecimento — Formal</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f4a7a">
  
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    :root{
      --blue:#0f4a7a;
      --green:#25D366;
      --red:#d9534f;
      --grey: #6c757d;
      --muted:#666;
      --paper:#fff;
      --page-width:21cm;
      --page-height:29.7cm;
      --base-font:18px;
    }
    html,body{height:100%;margin:0;background:#f3f6f9;font-family:'Lato',system-ui,Arial;color:#222}
    .sheet{
      width:var(--page-width);
      min-height:var(--page-height);
      margin:20px auto;
      background:var(--paper);
      padding:26mm 22mm 26mm 22mm;
      box-shadow:0 6px 18px rgba(0,0,0,0.06);
      position:relative;
      box-sizing:border-box;
      font-size:var(--base-font);
      line-height:1.65;
      color:#222;
      z-index:1;
      border: 1px solid #ddd;
    }
    .header{display:flex;align-items:center;justify-content:space-between;border-bottom:4px solid var(--blue);padding-bottom:10px}
    .logo-small{height:72px;object-fit:contain}
    .govtext{flex:1;text-align:center;padding-left:10px}
    .govtext h1{margin:0;font-size:16px;font-weight:800;letter-spacing:0.6px}
    .govtext p{margin:0;font-size:13px;color:var(--muted)}
    .title{font-size:36px;text-align:center;color:var(--blue);font-weight:900;margin:28px 0 18px;text-transform:uppercase;letter-spacing:1.6px}
    .body{font-size:20px;color:#111}
    .body p{margin:0 0 14px}
    .body .strong{font-weight:800;color:#000}
    .cid{margin-top:14px;font-weight:700;color:var(--muted);font-size:16px}
    .cid .code{font-weight:900;color:#000;margin-right:8px}
    .cid .desc{font-weight:600}
    .cid small{display:block;color:var(--muted);font-weight:400;margin-top:6px}
    .watermark {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
      width: 60%; max-width: 680px; opacity: 0.0; pointer-events: none; z-index: 0;
      -webkit-print-color-adjust: exact; print-color-adjust: exact;
    }
    .watermark-text {
      position: absolute; left: 50%; transform: translateX(-50%); bottom: 42mm;
      font-size: 13px; color: rgba(0,0,0,0.24); font-weight: 700;
      text-align: center; z-index: 0; pointer-events: none; white-space: pre-line;
    }
    .signature-area{
      position:absolute; left:50%; top:56%; transform:translate(-50%,-50%);
      text-align:center; width:52%; max-width:460px; z-index:2;
    }
    .signature-line{height:92px;border-bottom:1px solid #000;margin-bottom:8px}
    .signature-name{font-weight:900;font-size:16px;position:relative;z-index:3}
    .signature-role{font-size:13px;color:var(--muted);position:relative;z-index:3}
    .stamp {
      position: absolute; top: -34px; left: 50%; transform: translateX(-50%) rotate(-8deg);
      width: 160px; opacity: 0.88; mix-blend-mode: multiply; pointer-events: none; z-index:2;
      -webkit-print-color-adjust: exact; print-color-adjust: exact;
    }
    .footer{position:absolute;left:22mm;bottom:18mm;font-size:14px;color:var(--muted);width:calc(var(--page-width) - 44mm);box-sizing:border-box;text-align:left;border-top:1px solid #eee;padding-top:6px}
    .auth-inline{float:right;font-weight:700;color:#333}
    .controls{display:flex;flex-direction:column;gap:12px;padding:16px;background:#fff;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,0.06);max-width:21cm;margin:8px auto}
    .controls h3 { margin: 0 0 8px 0; font-size: 16px; color: var(--blue); border-bottom: 2px solid #eee; padding-bottom: 6px; }
    .controls label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    .controls input,.controls select,.controls a.btn{padding:8px;border:1px solid #ddd;border-radius:4px;font-size:15px; width: 100%; box-sizing: border-box; text-decoration: none;}
    .controls .row{display:flex;gap:12px; align-items: flex-end;}
    .controls .row > *{flex:1}
    .controls .full-width { flex-basis: 100%; }
    .muted-note{font-size:13px;color:var(--muted)}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 14px;border-radius:6px;border:0;color:#fff;font-weight:700;cursor:pointer; width: 100%;}
    .btn-print{background:var(--red)}
    .btn-whatsapp{background:var(--green)}
    .btn-secondary{background:var(--grey)}
    .formal-border {
      position: absolute; top: 10mm; left: 10mm; right: 10mm; bottom: 10mm;
      border: 2px solid var(--blue); pointer-events: none; box-sizing: border-box; z-index: 0;
    }
    .feedback-container { min-height: 40px; display: flex; align-items: center; justify-content: center; }
    .feedback-container p {
      display: inline-block; margin: 0; padding: 8px 12px; border-radius: 6px; font-weight: 700;
      overflow: hidden; border-right: .15em solid; white-space: nowrap; vertical-align: middle; max-width: 100%;
    }
    .feedback-container p.success { background: #d4edda; color: #155724; border-color: #155724; }
    .feedback-container p.error { background: #f8d7da; color: #721c24; border-color: #721c24; }
    .feedback-container p.info { background: #d1ecf1; color: #0c5460; border-color: #0c5460; }
    @keyframes typing { from { width: 0 } to { width: 100% } }
    @keyframes blink-caret { from, to { border-color: transparent } 50% { border-color: inherit; } }
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.6); display: none; align-items: center;
      justify-content: center; z-index: 1000; backdrop-filter: blur(5px);
    }
    .modal-overlay.active { display: flex; }
    .modal-content {
      background: #fff; padding: 24px 32px; border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3); text-align: center;
      max-width: 400px; width: 90%;
    }
    .modal-content h2 { margin: 0 0 20px; color: var(--blue); font-weight: 700; }
    .modal-content label { text-align: left; }
    .modal-content .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
    .professional-list { display: flex; flex-direction: column; gap: 12px; }
    .professional-btn {
      padding: 12px; border: 1px solid #ddd; border-radius: 6px; background: #f9f9f9;
      cursor: pointer; font-size: 16px; font-weight: 600;
      transition: background-color 0.2s, color 0.2s, transform 0.2s; width: 100%;
    }
    .professional-btn:hover { background-color: var(--blue); color: #fff; transform: translateY(-2px); }

    @media print{
      body{background:transparent}
      .sheet{ box-shadow:none; margin:0; padding:18mm; border-radius:0; border: none; zoom: 95%; }
      .formal-border { top: 0mm; left: 0mm; right: 0mm; bottom: 0mm; border: 2mm solid var(--blue); position: fixed; }
      .controls {display:none}
      @page{size:A4;margin:0mm;}
      .watermark { opacity: 0.10 !important; width: 66% !important; filter: grayscale(100%) contrast(110%) !important; }
      .watermark-text { color: rgba(0,0,0,0.34) !important; font-size: 12px !important; }
      .stamp { mix-blend-mode: normal !important; filter: grayscale(100%) contrast(130%) brightness(95%) !important; opacity: 0.98 !important; width: 34% !important; left: 50%; transform: translateX(-50%) rotate(-8deg); z-index:2; }
      .signature-name, .signature-role { z-index:3 !important; position:relative !important; }
      img, .stamp, .watermark { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
    }
  </style>
</head>
<body>
  
  <div class="sheet" id="doc">
    <div class="formal-border"></div>
    <img class="watermark" src="https://i.imgur.com/fIO428k.png" alt="Marca d'água oficial" crossorigin="anonymous" />
    <div class="watermark-text">
      CNES: 2085879 · AVENIDA PAULICÉIA 360 · (11) 4899-3367
      <br>PARA CONFIRMAR AUTENTICIDADE
    </div>
    <div class="header">
      <div class="left"><img class="logo-small" id="logo-left" src="https://i.imgur.com/v7MHC4w.png" alt="Brasão Prefeitura"></div>
      <div class="govtext">
        <h1>PREFEITURA DE CAIEIRAS<br>SECRETARIA MUNICIPAL DA SAÚDE</h1>
        <p>UNIDADE BÁSICA DE SAÚDE — UBS LARANJEIRAS</p>
      </div>
      <div class="right"><img class="logo-small" id="logo-right" src="https://i.imgur.com/A1eWZK0.png" alt="SUS"></div>
    </div>
    <div class="title">Declaração de Comparecimento</div>
    <div class="body" id="body-text">
      <p>Declaramos, para os devidos fins, que <span class="strong" id="ex-paciente">NOME COMPLETO DO(A) PACIENTE</span>, portador(a) do CPF nº <span class="strong" id="ex-cpf">000.000.000-00</span>, compareceu à <span class="strong" id="ex-unidade">UBS Laranjeiras</span>, na data de <span class="strong" id="ex-data">DD/MM/AAAA</span>, no período compreendido entre <span class="strong" id="ex-hora-inicio">hh:mm</span> e <span class="strong" id="ex-hora-fim">hh:mm</span>, para a realização de <span class="strong" id="ex-procedimento">procedimento</span>.</p>
      <p class="cid">CID: <span class="code" id="ex-cid">---</span> <span class="desc" id="ex-cid-desc">Descrição detalhada do procedimento / motivo</span>
        <small>OBS.: Verificado e registrado o CID conforme documentação clínica e tabela oficial vigente.</small>
      </p>
    </div>
    <div class="signature-area" id="signature-area">
      <div class="signature-line" id="signature-line"></div>
      <div class="signature-name" id="sig-name">NOME DO PROFISSIONAL</div>
      <div class="signature-role" id="sig-role">UBS Laranjeiras</div>
      <img id="stamp-img" src="https://i.imgur.com/lLAQqeK.png" alt="Carimbo Oficial" class="stamp" crossorigin="anonymous">
    </div>
    <div class="footer">
      Caieiras - SP, <span id="footer-date">DD de mês de AAAA</span>
      <span class="auth-inline">ID DE AUTENTICAÇÃO: <strong id="auth-id-value">—</strong></span>
    </div>
  </div>

  <div class="controls no-print" aria-hidden="false">
    <h3>Dados do Paciente</h3>
    <div class="row">
      <div>
        <label for="input-nome">Nome Completo</label>
        <input type="text" id="input-nome" placeholder="Nome do Paciente" />
      </div>
      <div>
        <label for="input-cpf">CPF</label>
        <input type="text" id="input-cpf" placeholder="000.000.000-00" maxlength="14" />
      </div>
    </div>

    <h3>Detalhes do Atendimento</h3>
    <div class="row">
      <div class="full-width">
        <label for="input-procedimento">Procedimento / Motivo</label>
        <select id="input-procedimento"></select>
      </div>
    </div>
    <div class="row">
        <div class="full-width">
          <label for="input-profissional">Profissional Responsável (pode ser alterado aqui)</label>
          <select id="input-profissional"></select>
        </div>
    </div>
    <div class="row">
      <div>
        <label for="input-data">Data</label>
        <input type="date" id="input-data" />
      </div>
      <div>
        <label for="input-hora-inicio">Início</label>
        <input type="time" id="input-hora-inicio" />
      </div>
      <div>
        <label for="input-hora-fim">Término</label>
        <input type="time" id="input-hora-fim" />
      </div>
    </div>

    <h3>Finalização e Modelos</h3>
    <div id="feedback-container" class="feedback-container"></div>
    <div class="row">
        <button id="send-whatsapp" class="btn btn-whatsapp"><i class="fab fa-whatsapp"></i> Enviar via WhatsApp</button>
        <button id="regprint" class="btn btn-print"><i class="fas fa-print"></i> Registrar e Imprimir</button>
    </div>
    <div class="row" style="margin-top: 10px;">
        <button id="download-blank-btn" class="btn btn-secondary"><i class="fas fa-download"></i> Baixar Modelo Recepção</button>
        <a href="portador do.PDF" id="download-oficial-pdf" class="btn btn-secondary" target="_blank" download><i class="fas fa-file-pdf"></i> Baixar PDF Oficial</a>
    </div>
    <div class="muted-note" style="text-align: center;">A atualização do documento é feita em tempo real.</div>
  </div>

  <div id="professional-modal-overlay" class="modal-overlay">
    <div class="modal-content">
      <h2>Selecione o Profissional</h2>
      <div id="professional-list" class="professional-list"></div>
    </div>
  </div>

  <div id="whatsapp-modal-overlay" class="modal-overlay">
    <div class="modal-content">
      <h2>Enviar via WhatsApp</h2>
      <div>
          <label for="modal-input-whatsapp">Número do Paciente (com DDD)</label>
          <input type="tel" id="modal-input-whatsapp" placeholder="11912345678" />
      </div>
      <div class="modal-actions">
          <button id="modal-btn-cancel" class="btn btn-print" style="background-color: #6c757d;">Cancelar</button>
          <button id="modal-btn-send" class="btn btn-whatsapp"><i class="fab fa-whatsapp"></i> Confirmar e Enviar</button>
      </div>
    </div>
  </div>

<script>
/* ============================ CONFIGURAÇÃO ================================ */
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwyAyqmZlfLVRR8dgjqHTWl_jGYfAID3F_cTqrDsbLkkXDJusdPz9mdXswyzQZP1ejH/exec';
const OFFLINE_STORAGE_KEY = 'offlineDeclarations';

// COLE AQUI O LINK PÚBLICO DO SEU PDF DO GOOGLE DRIVE
const URL_PDF_OFICIAL = 'portador do.PDF';

const PROFISSIONAIS = [
    { nome: "Adriana Maria", carimboUrl: "https://i.imgur.com/HrmcNkI.png" },
    { nome: "Mauricio Matheus Dias Oliveira", carimboUrl: "https://i.imgur.com/lLAQqeK.png", selecionado: true },
    { nome: "Joyce Cristina De Queiroz Trevizam", carimboUrl: "" },
    { nome: "Recepção", carimboUrl: "" }
];

const PROCEDIMENTOS = [
    { texto: "Consulta geral", valor: "Consulta médica geral", cid: "Z00.0", desc: "Exame clínico de rotina / avaliação médica" },
    { texto: "Retorno de consulta", valor: "Retorno de consulta médica", cid: "Z09.8", desc: "Exame de seguimento de rotina" },
    { texto: "Consulta odontológica", valor: "Consulta odontológica", cid: "Z01.2", desc: "Exame dentário de rotina" },
    { texto: "Consulta psicológica", valor: "Consulta psicológica", cid: "Z71.9", desc: "Aconselhamento não especificado" },
    { texto: "Consulta de pré-natal", valor: "Consulta de acompanhamento pré-natal", cid: "Z34", desc: "Supervisão de gravidez normal" },
    { texto: "Curativo", valor: "Realização de curativo", cid: "Z48.0", desc: "Atenção e cuidados com curativos" },
    { texto: "Administração de medicação", valor: "Administração de medicação", cid: "Z51.8", desc: "Cuidado médico especificado (ex: injetáveis)" },
    { texto: "Nebulização / Inalação", valor: "Sessão de nebulização/inalação", cid: "Z51.8", desc: "Cuidados médicos (terapia respiratória)" },
    { texto: "Retirada de pontos", valor: "Retirada de pontos (sutura)", cid: "Z48.0", desc: "Atenção a curativos e suturas" },
    { texto: "Vacinação", valor: "Vacinação", cid: "Z23.8", desc: "Vacinação profilática" },
    { texto: "Aferição de pressão arterial", valor: "Aferição de pressão arterial", cid: "Z13.6", desc: "Rastreamento de doenças cardiovasculares" },
    { texto: "Exame preventivo (Papanicolau)", valor: "Exame preventivo ginecológico (Papanicolau)", cid: "Z01.4", desc: "Exame ginecológico de rotina" },
    { texto: "Exame de sangue", valor: "Coleta para exame laboratorial", cid: "Z01.7", desc: "Exames laboratoriais" },
    { texto: "Acompanhante", valor: "Acompanhamento de paciente", cid: "Z76.3", desc: "Pessoa sadia acompanhando pessoa doente" },
    { texto: "Troca de receita", valor: "Renovação de prescrição médica", cid: "Z76.0", desc: "Emissão de prescrição de repetição" },
    { texto: "Retirada de exames / Insumos", valor: "Retirada de exames / Insumos", cid: "Z76.8", desc: "Contato com o serviço para fins administrativos" }
];

const FRASES_DE_ELOGIO = ["Excelente trabalho, {nome}!", "Serviço impecável, {nome}!", "Mais um ótimo atendimento, {nome}!", "Parabéns pelo profissionalismo, {nome}!"];
/* ========================================================================= */

const elements = {
    inputNome: document.getElementById('input-nome'),
    inputCpf: document.getElementById('input-cpf'),
    inputProc: document.getElementById('input-procedimento'),
    inputProf: document.getElementById('input-profissional'),
    inputData: document.getElementById('input-data'),
    inputHoraInicio: document.getElementById('input-hora-inicio'),
    inputHoraFim: document.getElementById('input-hora-fim'),
    exPaciente: document.getElementById('ex-paciente'),
    exCpf: document.getElementById('ex-cpf'),
    exData: document.getElementById('ex-data'),
    exHoraInicio: document.getElementById('ex-hora-inicio'),
    exHoraFim: document.getElementById('ex-hora-fim'),
    exProc: document.getElementById('ex-procedimento'),
    sigName: document.getElementById('sig-name'),
    stampImg: document.getElementById('stamp-img'),
    footerDate: document.getElementById('footer-date'),
    authValueEl: document.getElementById('auth-id-value'),
    regPrintBtn: document.getElementById('regprint'),
    sendWhatsappBtn: document.getElementById('send-whatsapp'),
    downloadBlankBtn: document.getElementById('download-blank-btn'),
    downloadOficialPdf: document.getElementById('download-oficial-pdf'),
    feedbackContainer: document.getElementById('feedback-container'),
    professionalModalOverlay: document.getElementById('professional-modal-overlay'),
    professionalList: document.getElementById('professional-list'),
    whatsappModalOverlay: document.getElementById('whatsapp-modal-overlay'),
    modalInputWhatsapp: document.getElementById('modal-input-whatsapp'),
    modalBtnSend: document.getElementById('modal-btn-send'),
    modalBtnCancel: document.getElementById('modal-btn-cancel')
};

let estaRegistrando = false;

const formatarNome = (nome) => nome.toLowerCase().replace(/(?:^|\s)\S/g, char => char.toUpperCase());
const formatarCPF = (cpf) => {
    let valor = cpf.replace(/\D/g, '');
    valor = valor.replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d{1,2})$/, '$1-$2');
    return valor;
};
const pad = (n) => String(n).padStart(2, '0');
const formatDateLong = (d) => {
  const meses = ['janeiro', 'fevereiro', 'março', 'abril', 'maio', 'junho', 'julho', 'agosto', 'setembro', 'outubro', 'novembro', 'dezembro'];
  return `${d.getDate()} de ${meses[d.getMonth()]} de ${d.getFullYear()}`;
};

function showMessage(text, type = 'success') {
    elements.feedbackContainer.innerHTML = '';
    const p = document.createElement('p');
    p.textContent = text;
    p.className = type;
    const duracaoAnimacao = Math.max(1.5, text.length * 0.05);
    p.style.animation = `typing ${duracaoAnimacao}s steps(${text.length * 2}, end), blink-caret .75s step-end infinite`;
    elements.feedbackContainer.appendChild(p);
    setTimeout(() => { elements.feedbackContainer.innerHTML = ''; }, (duracaoAnimacao * 1000) + 4000);
}

function preencherCamposComDataAtual() {
  const agora = new Date();
  if (!elements.inputData.value) elements.inputData.valueAsDate = agora;
  if (!elements.inputHoraInicio.value) {
    const inicio = new Date(agora.getTime() - 30 * 60000);
    elements.inputHoraInicio.value = `${pad(inicio.getHours())}:${pad(inicio.getMinutes())}`;
  }
  if (!elements.inputHoraFim.value) {
    const termino = new Date(agora.getTime() + 10 * 60000);
    elements.inputHoraFim.value = `${pad(termino.getHours())}:${pad(termino.getMinutes())}`;
  }
}

function popularSeletores() {
    PROFISSIONAIS.forEach(prof => {
        const option = new Option(prof.nome, prof.nome);
        option.dataset.stampUrl = prof.carimboUrl || '';
        if (prof.selecionado) option.selected = true;
        elements.inputProf.add(option);
    });
    PROCEDIMENTOS.forEach(proc => {
        const option = new Option(proc.texto, proc.valor);
        option.dataset.cid = proc.cid;
        option.dataset.desc = proc.desc;
        elements.inputProc.add(option);
    });
}

function aplicarValores() {
  const nome = elements.inputNome.value.trim() || 'NOME COMPLETO DO(A) PACIENTE';
  const cpf = elements.inputCpf.value.trim() || '000.000.000-00';
  const selectedProcOption = elements.inputProc.selectedOptions[0];
  const procedimento = selectedProcOption?.value || 'Procedimento';
  const cid = selectedProcOption?.dataset.cid || '---';
  const cidDesc = selectedProcOption?.dataset.desc || '';
  const selectedProfOption = elements.inputProf.selectedOptions[0];
  const profissional = selectedProfOption?.value || 'NOME DO PROFISSIONAL';
  const carimboUrl = selectedProfOption?.dataset.stampUrl || '';
  let dataVal = elements.inputData.value, horaInicioVal = elements.inputHoraInicio.value, horaFimVal = elements.inputHoraFim.value;

  if (!dataVal || !horaInicioVal || !horaFimVal) {
    preencherCamposComDataAtual();
    dataVal = elements.inputData.value; horaInicioVal = elements.inputHoraInicio.value; horaFimVal = elements.inputHoraFim.value;
  }
  
  elements.exPaciente.textContent = formatarNome(nome);
  elements.exCpf.textContent = cpf;
  const [yyyy, mm, dd] = dataVal.split('-');
  elements.exData.textContent = `${dd}/${mm}/${yyyy}`;
  elements.exHoraInicio.textContent = horaInicioVal;
  elements.exHoraFim.textContent = horaFimVal;
  elements.exProc.textContent = procedimento;
  document.getElementById('ex-cid').textContent = cid;
  document.getElementById('ex-cid-desc').textContent = cidDesc;
  elements.sigName.textContent = profissional;
  elements.stampImg.src = carimboUrl;
  elements.stampImg.style.display = carimboUrl ? 'block' : 'none';
  elements.footerDate.textContent = formatDateLong(new Date(`${dataVal}T00:00:00`));
}

function showProfessionalModal() {
    elements.professionalList.innerHTML = '';
    PROFISSIONAIS.forEach(prof => {
        const btn = document.createElement('button');
        btn.className = 'professional-btn';
        btn.textContent = prof.nome;
        btn.onclick = () => {
            elements.inputProf.value = prof.nome;
            elements.inputProf.dispatchEvent(new Event('change'));
            elements.professionalModalOverlay.classList.remove('active');
        };
        elements.professionalList.appendChild(btn);
    });
    elements.professionalModalOverlay.classList.add('active');
}

function showWhatsappModal() {
    if (!validarCampos(false)) return;
    elements.whatsappModalOverlay.classList.add('active');
    elements.modalInputWhatsapp.focus();
}

function gerarIdUnico() {
  const now = new Date();
  const datePart = `${now.getFullYear()}${pad(now.getMonth() + 1)}${pad(now.getDate())}`;
  const timePart = `${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;
  const rndPart = Math.random().toString(36).substring(2, 7).toUpperCase();
  return `UBS-${datePart}${timePart}-${rndPart}`;
}

async function registrarDeclaracao() {
  if (estaRegistrando) return null;
  estaRegistrando = true;
  const id = gerarIdUnico();

  // Formata a data para o padrão brasileiro antes de enviar
  const [yyyy, mm, dd] = elements.inputData.value.split('-');
  const dataFormatada = `${dd}/${mm}/${yyyy}`;

  const payload = {
    ID: id, Nome: elements.inputNome.value.trim(), CPF: elements.inputCpf.value.trim(),
    DataAtendimento: dataFormatada, // <-- MUDANÇA AQUI
    HorarioAtendimento: `${elements.inputHoraInicio.value} - ${elements.inputHoraFim.value}`,
    TipoAtendimento: elements.inputProc.value, Justificativa: elements.inputProc.selectedOptions[0]?.dataset.desc || '',
    Profissional: elements.inputProf.value, DataEmissao: new Date().toLocaleDateString('pt-BR'),
    HoraEmissao: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
  };
  elements.authValueEl.textContent = id;
  try {
    if (navigator.onLine) {
        await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
        const nomeProfissional = payload.Profissional.split(' ')[0];
        const fraseAleatoria = FRASES_DE_ELOGIO[Math.floor(Math.random() * FRASES_DE_ELOGIO.length)];
        showMessage(fraseAleatoria.replace('{nome}', nomeProfissional), 'success');
    } else {
        const offlineData = JSON.parse(localStorage.getItem(OFFLINE_STORAGE_KEY) || '[]');
        offlineData.push(payload);
        localStorage.setItem(OFFLINE_STORAGE_KEY, JSON.stringify(offlineData));
        showMessage('Salvo localmente! Será enviado quando houver conexão.', 'info');
    }
    return id;
  } catch (error) {
    console.error('Erro ao registrar:', error);
    showMessage(`Falha ao registrar. Tente novamente.`, 'error');
    return null;
  } finally {
    estaRegistrando = false;
  }
}

async function syncOfflineData() {
    const offlineData = JSON.parse(localStorage.getItem(OFFLINE_STORAGE_KEY) || '[]');
    if (offlineData.length === 0) return;
    showMessage(`Sincronizando ${offlineData.length} registros...`, 'info');
    const failedToSend = [];
    for (const payload of offlineData) {
        try {
            await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
        } catch (error) {
            failedToSend.push(payload);
        }
    }
    localStorage.setItem(OFFLINE_STORAGE_KEY, JSON.stringify(failedToSend));
    if (failedToSend.length === 0) showMessage('Todos os registros foram sincronizados!', 'success');
    else showMessage(`${failedToSend.length} registros não puderam ser enviados.`, 'error');
}

function validarCampos(isWhatsApp = false, whatsappNumber = '') {
  if (!elements.inputNome.value.trim()) { showMessage('Preencha o nome do paciente.', 'error'); return false; }
  if (elements.inputCpf.value.trim().length < 14) { showMessage('Preencha o CPF completo.', 'error'); return false; }
  if (isWhatsApp) {
    const phone = whatsappNumber.replace(/\D/g, '');
    if (phone.length < 10) { showMessage('Preencha um WhatsApp válido com DDD.', 'error'); return false; }
  }
  return true;
}

async function acaoRegistrarEImprimir() {
  if (!validarCampos()) return;
  elements.regPrintBtn.disabled = true;
  elements.regPrintBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Registrando...';
  aplicarValores();
  if (await registrarDeclaracao()) {
    setTimeout(() => window.print(), 500);
  }
  elements.regPrintBtn.disabled = false;
  elements.regPrintBtn.innerHTML = '<i class="fas fa-print"></i> Registrar e Imprimir';
}

async function acaoExecutarEnvioWhatsApp() {
    const whatsappNumber = elements.modalInputWhatsapp.value;
    if (!validarCampos(true, whatsappNumber)) return;
    elements.modalBtnSend.disabled = true;
    elements.modalBtnSend.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Gerando...';
    aplicarValores();
    const newId = await registrarDeclaracao();
    if (!newId) {
        elements.modalBtnSend.disabled = false;
        elements.modalBtnSend.innerHTML = '<i class="fab fa-whatsapp"></i> Confirmar e Enviar';
        return;
    }
    const element = document.getElementById('doc');
    const options = { margin: 0, filename: `Declaracao_${elements.inputNome.value.trim().replace(/ /g, '_')}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'cm', format: 'a4', orientation: 'portrait' } };
    await html2pdf().from(element).set(options).save();
    const phone = '55' + whatsappNumber.replace(/\D/g, '');
    const message = `Olá. Somos da *UBS Laranjeiras*. Segue a sua declaração de comparecimento em PDF.\n\n*ID de Autenticação:* ${newId}`;
    const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
    showMessage('PDF baixado! Anexe-o na conversa do WhatsApp.', 'info');
    elements.whatsappModalOverlay.classList.remove('active');
    setTimeout(() => {
        window.open(whatsappUrl, '_blank');
        elements.modalBtnSend.disabled = false;
        elements.modalBtnSend.innerHTML = '<i class="fab fa-whatsapp"></i> Confirmar e Enviar';
        elements.modalInputWhatsapp.value = '';
    }, 2000);
}

async function acaoBaixarEmBranco() {
    const bodyTextP = document.getElementById('body-text').querySelector('p');
    const cidBlock = document.querySelector('.cid');
    const originalBodyHTML = bodyTextP.innerHTML;
    const originalSigNameText = elements.sigName.textContent;
    const originalStampDisplay = elements.stampImg.style.display;
    bodyTextP.innerHTML = `Declaramos, para os devidos fins, que ______________________________________________________, portador(a) do CPF nº ________________________, esteve presente nesta unidade na data de _____/_____/_____, no período compreendido entre _____:_____ e _____:_____.`;
    cidBlock.style.display = 'none';
    elements.sigName.textContent = 'Recepção';
    elements.stampImg.style.display = 'none';
    const element = document.getElementById('doc');
    const options = {
        margin: 0,
        filename: 'Declaracao_em_Branco_Recepcao.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: 'cm', format: 'a4', orientation: 'portrait' }
    };
    await html2pdf().from(element).set(options).save();
    showMessage('PDF em branco para Recepção baixado!', 'info');
    bodyTextP.innerHTML = originalBodyHTML;
    cidBlock.style.display = '';
    elements.sigName.textContent = originalSigNameText;
    elements.stampImg.style.display = originalStampDisplay;
    aplicarValores();
}

// --- INICIALIZAÇÃO ---
document.addEventListener('DOMContentLoaded', () => {
  popularSeletores();
  elements.regPrintBtn.addEventListener('click', acaoRegistrarEImprimir);
  elements.sendWhatsappBtn.addEventListener('click', showWhatsappModal);
  elements.downloadBlankBtn.addEventListener('click', acaoBaixarEmBranco);
  elements.modalBtnSend.addEventListener('click', acaoExecutarEnvioWhatsApp);
  elements.modalBtnCancel.addEventListener('click', () => elements.whatsappModalOverlay.classList.remove('active'));
  
  if (URL_PDF_OFICIAL && URL_PDF_OFICIAL.startsWith('http')) {
      elements.downloadOficialPdf.href = URL_PDF_OFICIAL;
  } else {
      elements.downloadOficialPdf.style.display = 'none';
  }
  
  Object.values(elements).forEach(el => {
      if (el && (el.tagName === 'INPUT' || el.tagName === 'SELECT')) {
          el.addEventListener('input', aplicarValores);
          el.addEventListener('change', aplicarValores);
      }
  });

  elements.inputCpf.addEventListener('input', (e) => { e.target.value = formatarCPF(e.target.value); });
  window.addEventListener('beforeprint', aplicarValores);
  window.addEventListener('online', syncOfflineData);

  preencherCamposComDataAtual();
  showProfessionalModal();
  if(navigator.onLine) syncOfflineData();
});

// --- Service Worker Registration ---
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js').then(reg => console.log('Service Worker registrado:', reg.scope))
      .catch(err => console.log('Falha ao registrar Service Worker:', err));
  });
}
</script>

</body>
</html>
