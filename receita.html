<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Receituário Médico Inteligente</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Times New Roman', serif;
            background: #f5f7fa;
            min-height: 100vh;
            padding: 20px;
            color: #2c3e50;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .controls {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            border: 1px solid #e1e8ed;
        }

        .controls h2 {
            color: #2c3e50;
            margin-bottom: 25px;
            font-size: 24px;
            font-weight: 600;
            text-align: center;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #34495e;
            font-size: 14px;
        }

        .form-group input, .form-group textarea, .form-group select {
            padding: 12px;
            border: 2px solid #bdc3c7;
            border-radius: 4px;
            font-size: 16px; 
            transition: border-color 0.3s, box-shadow 0.3s;
            font-family: inherit;
        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 150px;
            font-family: 'Times New Roman', serif;
            line-height: 1.6; 
        }

        .autocomplete-items {
            position: absolute;
            border: 1px solid #d4d4d4;
            border-bottom: none;
            border-top: none;
            z-index: 99;
            top: 100%;
            left: 0;
            right: 0;
            background-color: #fff;
            border-radius: 0 0 4px 4px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .autocomplete-items div {
            padding: 10px;
            cursor: pointer;
            background-color: #fff; 
            border-bottom: 1px solid #d4d4d4; 
        }

        .autocomplete-items div:hover {
            background-color: #e9e9e9; 
        }

        .autocomplete-active {
            background-color: DodgerBlue !important; 
            color: #ffffff; 
        }

        .medicamentos-section {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }
        
        .categoria-medicamentos {
            margin-bottom: 10px;
        }

        .categoria-medicamentos h4 {
            font-size: 16px;
            color: #2c3e50;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .dropdown-group {
            display: flex;
            gap: 10px;
        }

        .medicamento-dropdown {
            flex-grow: 1;
            padding: 10px;
            border: 2px solid #bdc3c7;
            border-radius: 4px;
            background-color: white;
            font-size: 15px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007CB2%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 10px top 50%;
            background-size: 10px auto;
        }

        .btn-add-medicamento {
            padding: 0 20px;
            background: #0056b3;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn-add-medicamento:hover {
            background: #004494;
        }
        
        .buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 14px;
            min-width: 140px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary { background: #3498db; color: white; }
        .btn-primary:hover { background: #2980b9; transform: translateY(-1px); }
        .btn-secondary { background: #95a5a6; color: white; }
        .btn-secondary:hover { background: #7f8c8d; transform: translateY(-1px); }
        .btn-success { background: #0056b3; color: white; }
        .btn-success:hover { background: #004494; transform: translateY(-1px); }
        .btn-warning { background: #f39c12; color: white; }
        .btn-warning:hover { background: #e67e22; transform: translateY(-1px); }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-danger:hover { background: #c0392b; transform: translateY(-1px); }

        .preview-area {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
            border: 1px solid #e1e8ed;
        }

        .folha-impressao {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            padding: 20px;
        }

        .receituario {
            background-color: white;
            flex: 1;
            padding: 25px;
            border: 2px solid #34495e;
            border-radius: 4px;
            position: relative;
            min-height: 750px;
            display: flex;
            flex-direction: column;
        }
        
        .header { 
            display: flex; 
            justify-content: center;
            align-items: center; 
            border-bottom: 3px solid #3498db; 
            padding-bottom: 15px; 
            margin-bottom: 20px; 
            height: 70px;
        }

        .header-logo {
            max-height: 110%;
            max-width: 700px;
            width: auto;
        }
        
        .titulo-receituario { 
            text-align: center; 
            font-size: 22px; 
            font-weight: 700; 
            margin-bottom: 25px; 
            color: #2c3e50; 
            text-transform: uppercase; 
            letter-spacing: 1px; 
        }

        .info-paciente { 
            margin-bottom: 20px;
            padding: 15px; 
            background: #f8f9fa; 
            border-radius: 4px; 
            border-left: 4px solid #3498db; 
        }
        
        .linha-info { display: flex; align-items: center; margin-bottom: 8px; }
        .linha-info span { font-weight: 600; min-width: 100px; color: #34495e; }
        
        .linha-info .valor { 
            color: #2c3e50; 
            font-weight: 500;
            font-size: 21px;
        }
        .linha-info .valor#displayData, .linha-info .valor#displayData2 {
            font-size: 16px;
        }

        .corpo-receita {
            position: relative;
            z-index: 1;
            padding: 20px;
            background: #fdfdfd;
            border: 1px solid #ecf0f1;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 18px; 
            line-height: 1.8;
            white-space: pre-wrap;
            color: #2c3e50;
            overflow-y: auto; 
            overflow-wrap: break-word;
            height: 320px;
        }

        .receituario::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 350px; 
            height: 350px; 
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/thumb/1/10/Brasao_caieiras.png/800px-Brasao_caieiras.png');
            background-repeat: no-repeat;
            background-position: center;
            background-size: contain;
            opacity: 0.08; 
            z-index: 0;
        }
        
        .footer { 
            text-align: center; 
            padding-top: 20px; 
            font-size: 12px; 
            border-top: 2px solid #bdc3c7; 
            margin-top: auto;
        }

        .assinatura-area { display: flex; justify-content: center; margin-bottom: 20px; gap: 20px; }
        .assinatura { text-align: center; flex: 1; max-width: 300px; }
        .linha-assinatura { border-top: 2px solid #2c3e50; padding-top: 8px; margin: 40px auto 8px; max-width: 280px; font-weight: 600; font-size: 15px; }
        .info-rodape { border-top: 2px solid #3498db; margin-top: 15px; padding-top: 10px; font-weight: 600; color: #3498db; font-size: 11px; }
        .carimbo-ubs { width: 100px; height: auto; margin: 10px auto; display: block; opacity: 0.7; }

        .medicos-lista { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-top: 20px; }
        .medico-card { padding: 20px; border: 2px solid #ecf0f1; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.3s; background: white; }
        .medico-card:hover { border-color: #3498db; background: #f8f9ff; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(52, 152, 219, 0.15); }
        .medico-card.selected { border-color: #3498db; background: #3498db; color: white; }
        .medico-card h4 { margin: 0 0 8px 0; font-size: 15px; font-weight: 600; }
        .medico-card small { font-size: 13px; opacity: 0.8; font-weight: 500; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); }
        .modal-content { background-color: white; margin: 5% auto; padding: 30px; border-radius: 8px; width: 90%; max-width: 700px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); border: 1px solid #e1e8ed; }
        .modal h3 { text-align: center; color: #2c3e50; margin-bottom: 25px; font-size: 22px; font-weight: 600; }
        .close { color: #95a5a6; float: right; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 1; transition: color 0.3s; }
        .close:hover { color: #e74c3c; }

        .contador-caracteres { text-align: right; font-size: 12px; color: #7f8c8d; margin-top: 5px; font-weight: 500; }
        .validacao { padding: 15px; border-radius: 4px; margin-top: 15px; font-size: 14px; font-weight: 500; }
        .validacao.sucesso { background: #d5f4e6; color: #27ae60; border: 1px solid #27ae60; }
        .validacao.erro { background: #fadbd8; color: #e74c3c; border: 1px solid #e74c3c; }
        .validacao.aviso { background: #fef9e7; color: #f39c12; border: 1px solid #f39c12; }
        
        .selecionar-medico-btn { margin-top: 8px; width: 100%; }

        @media (max-width: 768px) {
            .folha-impressao { flex-direction: column; gap: 20px; }
            .form-grid, .medicamentos-section { grid-template-columns: 1fr; }
            .buttons { justify-content: center; }
            .medicos-lista { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
        }

        /* --- ESTILOS DE IMPRESSÃO ATUALIZADOS --- */
        @media print {
            @page {
                size: A4 landscape;
                margin: 0; /* --- AJUSTE: Margens mínimas para impressão --- */
            }

            html, body {
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
                background: white !important;
                zoom: 0.9; /* --- AJUSTE: Escala de 90% para impressão --- */
            }

            .controls, .modal, .autocomplete-items {
                display: none !important;
            }

            .container, .preview-area {
                max-width: 100% !important;
                width: 100% !important;
                height: 100%;
                margin: 0 !important;
                padding: 0 !important;
                border: none !important;
                box-shadow: none !important;
            }

            .folha-impressao {
                display: flex;
                flex-direction: row;
                justify-content: space-between;
                align-items: flex-start;
                width: 100%;
                height: 100%;
                padding: 1cm; /* Adiciona um respiro interno na folha */
                gap: 20px;
            }

            .receituario {
                box-sizing: border-box;
                width: 48%;
                height: 100%;
                margin: 0;
                padding: 15px;
                border: 2px solid #000 !important;
                page-break-inside: avoid;
                display: flex;
                flex-direction: column;
            }

            .info-paciente, .corpo-receita {
                background: white !important;
            }
            
            .corpo-receita {
                border: 1px solid #ccc !important;
                font-size: 15px !important;
                overflow: visible !important; 
                height: auto !important;
                flex-grow: 1;
            }

            .titulo-receituario, .header, .info-rodape {
                color: #000 !important;
                border-color: #000 !important;
            }

            .receituario::before {
                opacity: 0.1 !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="controls">
            <h2>Sistema de Receituário Médico Inteligente</h2>
            
            <div class="form-grid">
                <div class="form-group">
                    <label for="nomePaciente">Nome do Paciente *</label>
                    <input type="text" id="nomePaciente" placeholder="Digite o nome completo do paciente">
                </div>
                
                <div class="form-group">
                    <label for="crm">CRM do Médico</label>
                    <input type="text" id="crm" placeholder="Selecione um médico" readonly>
                </div>
                
                <div class="form-group">
                    <label for="nomeMedico">Médico Responsável</label>
                    <input type="text" id="nomeMedico" placeholder="Nenhum médico selecionado" readonly>
                    <button type="button" class="btn btn-secondary selecionar-medico-btn" onclick="abrirModalMedicos()">
                        Selecionar Médico
                    </button>
                </div>
            </div>

            <div class="form-group">
                <label for="prescricao">Prescrição Médica *</label>
                <textarea id="prescricao" placeholder="Digite a prescrição ou selecione um medicamento abaixo..."></textarea>
                <div class="contador-caracteres">
                    <span id="contadorCaracteres">0/1000 caracteres</span>
                </div>
            </div>

            <div class="medicamentos-section">
                <div class="categoria-medicamentos">
                    <h4>Analgésicos e Antitérmicos</h4>
                    <div class="dropdown-group">
                        <select id="select-analgesicos" class="medicamento-dropdown">
                            <option value="" disabled selected>Selecione um medicamento...</option>
                            <option value="Dipirona 500mg" data-posologia="tomar 1 comprimido de 6 em 6 horas, se dor ou febre.">Dipirona 500mg</option>
                            <option value="Dipirona Gotas 500mg/ml" data-posologia="tomar 20 a 40 gotas, até 4 vezes ao dia, se dor ou febre.">Dipirona Gotas</option>
                            <option value="Paracetamol 750mg" data-posologia="tomar 1 comprimido de 8 em 8 horas, se dor ou febre.">Paracetamol 750mg</option>
                            <option value="Paracetamol Gotas 200mg/ml" data-posologia="tomar 1 gota por Kg de peso, até de 6 em 6 horas.">Paracetamol Gotas</option>
                        </select>
                        <button class="btn-add-medicamento" onclick="adicionarMedicamentoDoDropdown('select-analgesicos')">Adicionar</button>
                    </div>
                </div>

                <div class="categoria-medicamentos">
                    <h4>Anti-inflamatórios</h4>
                    <div class="dropdown-group">
                        <select id="select-antiinflamatorios" class="medicamento-dropdown">
                            <option value="" disabled selected>Selecione um medicamento...</option>
                            <option value="Ibuprofeno 400mg" data-posologia="tomar 1 comprimido de 8 em 8 horas por 5 dias.">Ibuprofeno 400mg</option>
                            <option value="Nimesulida 100mg" data-posologia="tomar 1 comprimido de 12 em 12 horas por 5 dias.">Nimesulida 100mg</option>
                            <option value="Diclofenaco 50mg" data-posologia="tomar 1 comprimido de 8 em 8 horas por 5 dias.">Diclofenaco 50mg</option>
                        </select>
                        <button class="btn-add-medicamento" onclick="adicionarMedicamentoDoDropdown('select-antiinflamatorios')">Adicionar</button>
                    </div>
                </div>
                
                <div class="categoria-medicamentos">
                    <h4>Antibióticos</h4>
                    <div class="dropdown-group">
                         <select id="select-antibioticos" class="medicamento-dropdown">
                            <option value="" disabled selected>Selecione um medicamento...</option>
                            <option value="Amoxicilina 500mg" data-posologia="tomar 1 cápsula de 8 em 8 horas por 7 dias.">Amoxicilina 500mg</option>
                            <option value="Amoxicilina + Clavulanato 875/125mg" data-posologia="tomar 1 comprimido de 12 em 12 horas por 7 dias.">Amoxi + Clavulanato</option>
                            <option value="Azitromicina 500mg" data-posologia="tomar 1 comprimido, uma vez ao dia, por 3 ou 5 dias.">Azitromicina 500mg</option>
                            <option value="Cefalexina 500mg" data-posologia="tomar 1 cápsula de 6 em 6 horas por 7 dias.">Cefalexina 500mg</option>
                        </select>
                        <button class="btn-add-medicamento" onclick="adicionarMedicamentoDoDropdown('select-antibioticos')">Adicionar</button>
                    </div>
                </div>
                
                <div class="categoria-medicamentos">
                    <h4>Antialérgicos e Corticoides</h4>
                    <div class="dropdown-group">
                        <select id="select-antialergicos" class="medicamento-dropdown">
                            <option value="" disabled selected>Selecione um medicamento...</option>
                            <option value="Loratadina 10mg" data-posologia="tomar 1 comprimido ao dia por 10 dias.">Loratadina 10mg</option>
                            <option value="Dexclorfeniramina 2mg" data-posologia="tomar 1 comprimido de 8 em 8 horas, se necessário.">Dexclorfeniramina 2mg</option>
                            <option value="Prednisona 20mg" data-posologia="tomar 1 comprimido pela manhã por 5 dias.">Prednisona 20mg</option>
                        </select>
                         <button class="btn-add-medicamento" onclick="adicionarMedicamentoDoDropdown('select-antialergicos')">Adicionar</button>
                    </div>
                </div>

                <div class="categoria-medicamentos">
                    <h4>Gastrointestinais</h4>
                    <div class="dropdown-group">
                        <select id="select-gastro" class="medicamento-dropdown">
                            <option value="" disabled selected>Selecione um medicamento...</option>
                            <option value="Omeprazol 20mg" data-posologia="tomar 1 cápsula em jejum por 14 dias ou mais.">Omeprazol 20mg</option>
                            <option value="Metoclopramida 10mg" data-posologia="tomar 1 comprimido até de 8 em 8 horas, se náuseas ou vômitos.">Metoclopramida 10mg</option>
                            <option value="Escopolamina + Dipirona" data-posologia="tomar 1 comprimido até de 6 em 6 horas, se cólicas.">Buscopan Composto</option>
                        </select>
                        <button class="btn-add-medicamento" onclick="adicionarMedicamentoDoDropdown('select-gastro')">Adicionar</button>
                    </div>
                </div>

                <div class="categoria-medicamentos">
                    <h4>Cardiovasculares e Diuréticos</h4>
                    <div class="dropdown-group">
                        <select id="select-cardio" class="medicamento-dropdown">
                            <option value="" disabled selected>Selecione um medicamento...</option>
                             <option value="Captopril 25mg" data-posologia="tomar 1 comprimido de 12 em 12 horas.">Captopril 25mg</option>
                            <option value="Losartana 50mg" data-posologia="tomar 1 comprimido uma vez ao dia.">Losartana 50mg</option>
                            <option value="Hidroclorotiazida 25mg" data-posologia="tomar 1 comprimido pela manhã.">Hidroclorotiazida 25mg</option>
                            <option value="Sinvastatina 20mg" data-posologia="tomar 1 comprimido à noite.">Sinvastatina 20mg</option>
                            <option value="Atenolol 50mg" data-posologia="tomar 1 comprimido pela manhã.">Atenolol 50mg</option>
                        </select>
                        <button class="btn-add-medicamento" onclick="adicionarMedicamentoDoDropdown('select-cardio')">Adicionar</button>
                    </div>
                </div>
            </div>

            <div class="buttons">
                <button class="btn btn-primary" onclick="atualizarReceituario()">Atualizar Visualização</button>
                <button class="btn btn-success" onclick="imprimirReceituario()">Imprimir Receituário</button>
                <button class="btn btn-warning" onclick="salvarRascunho()">Salvar Rascunho</button>
                <button class="btn btn-secondary" onclick="carregarRascunho()">Carregar Rascunho</button>
                <button class="btn btn-danger" onclick="limparFormulario()">Limpar Formulário</button>
            </div>

            <div id="validacao"></div>
        </div>

        <div class="preview-area">
            <div class="folha-impressao">
                <div class="receituario">
                    <header class="header">
                        <img src="https://i.imgur.com/xkDHE6r.png" alt="Prefeitura de Caieiras" class="header-logo">
                    </header>
                    
                    <p class="titulo-receituario">RECEITUÁRIO MÉDICO</p>
                    
                    <div class="info-paciente">
                        <div class="linha-info">
                            <span>Paciente:</span>
                            <span class="valor" id="displayNome">_______________________</span>
                        </div>
                        <div class="linha-info">
                            <span>Data:</span>
                            <span class="valor" id="displayData">___/___/______</span>
                        </div>
                    </div>
                    
                    <div class="corpo-receita" id="displayPrescricao">
                        [Prescrição médica será exibida aqui]
                    </div>
                    
                    <footer class="footer">
                        <div class="assinatura-area">
                            <div class="assinatura">
                                <img src="https://i.imgur.com/RewqGRz.png" alt="Carimbo UBS" class="carimbo-ubs">
                                <div class="linha-assinatura">
                                    <span id="displayMedico">ASSINATURA E CARIMBO DO MÉDICO</span>
                                </div>
                                <small>CRM-SP: <span id="displayCrm">______</span></small>
                            </div>
                        </div>
                        <div class="info-rodape">
                            www.caieiras.sp.gov.br | @prefeituradecaieiras
                        </div>
                    </footer>
                </div>

                <div class="receituario">
                    <header class="header">
                        <img src="https://i.imgur.com/xkDHE6r.png" alt="Prefeitura de Caieiras" class="header-logo">
                    </header>
                    
                    <p class="titulo-receituario">RECEITUÁRIO MÉDICO</p>
                    
                    <div class="info-paciente">
                        <div class="linha-info">
                            <span>Paciente:</span>
                            <span class="valor" id="displayNome2">_______________________</span>
                        </div>
                        <div class="linha-info">
                            <span>Data:</span>
                            <span class="valor" id="displayData2">___/___/______</span>
                        </div>
                    </div>
                    
                    <div class="corpo-receita" id="displayPrescricao2">
                        [Prescrição médica será exibida aqui]
                    </div>
                    
                    <footer class="footer">
                        <div class="assinatura-area">
                            <div class="assinatura">
                                <img src="https://i.imgur.com/RewqGRz.png" alt="Carimbo UBS" class="carimbo-ubs">
                                <div class="linha-assinatura">
                                    <span id="displayMedico2">ASSINATURA E CARIMBO DO MÉDICO</span>
                                </div>
                                <small>CRM-SP: <span id="displayCrm2">______</span></small>
                            </div>
                        </div>
                        <div class="info-rodape">
                            www.caieiras.sp.gov.br | @prefeituradecaieiras
                        </div>
                    </footer>
                </div>
            </div>
        </div>
    </div>

    <div id="modalMedicos" class="modal">
        <div class="modal-content">
            <span class="close" onclick="fecharModalMedicos()">&times;</span>
            <h3>Selecione o Médico Responsável</h3>
            
            <div class="medicos-lista">
                <div class="medico-card" onclick="selecionarMedico('Dr. Middihan Nascimento Santos de Sousa', '3506131/SP', this)">
                    <h4>Dr. Middihan Nascimento Santos de Sousa</h4>
                    <small>RMS: 3506131/SP</small>
                </div>
                <div class="medico-card" onclick="selecionarMedico('Dra. Bianca Lima', '259390', this)">
                    <h4>Dra. Bianca Nicoleti</h4>
                    <small>CRM-SP: 259390</small>
                </div>
                 <div class="medico-card" onclick="selecionarMedico('Dra. Nairobi Hernandez', '-', this)">
                    <h4>Dra. Nairobi Hernandez</h4>
                    <small>CRM-SP: -</small>
                </div>
                <div class="medico-card" onclick="selecionarMedico('Dr. José Guilherme Campos Martins', '263357', this)">
                    <h4>Dr. José Guilherme Campos Martins</h4>
                    <small>CRM-SP: 263357</small>
                </div>
                <div class="medico-card" onclick="selecionarMedico('Dr. Benedito Glauco Marçal', '-', this)">
                    <h4>Dr. Benedito Glauco Marçal</h4>
                    <small>CRM-SP: -</small>
                </div>
            </div>
        </div>
    </div>

    <script>
        // O JavaScript foi restaurado para a versão que inclui o CRM e a quebra de linha simples.
        const nomesPacientes = [
            "Ana Maria Braga", "Bernardo Silva", "Carlos Eduardo Pereira", "Daniela Albuquerque", "Eduardo Costa",
            "Fabiana Melo", "Gustavo Lima", "Helena Fernandes", "Igor Camargo", "Juliana Paes", "Lucas Moura",
            "Mariana Rios", "Nicolas Cage", "Olivia Newton-John", "Pedro Álvares Cabral", "Quintino Bocaiúva",
            "Rafaela Santos", "Sérgio Reis", "Tatiana Moreira", "Ulisses Guimarães", "Vitória Strada", "Washington Olivetto",
            "Xuxa Meneghel", "Yasmin Brunet", "Zeca Pagodinho"
        ];

        function autocomplete(inp, arr) {
            let currentFocus;
            inp.addEventListener("input", function(e) {
                let a, b, i, val = this.value;
                closeAllLists();
                if (!val) { return false; }
                currentFocus = -1;
                a = document.createElement("DIV");
                a.setAttribute("id", this.id + "autocomplete-list");
                a.setAttribute("class", "autocomplete-items");
                this.parentNode.appendChild(a);
                for (i = 0; i < arr.length; i++) {
                    if (arr[i].substr(0, val.length).toUpperCase() == val.toUpperCase()) {
                        b = document.createElement("DIV");
                        b.innerHTML = "<strong>" + arr[i].substr(0, val.length) + "</strong>";
                        b.innerHTML += arr[i].substr(val.length);
                        b.innerHTML += "<input type='hidden' value='" + arr[i] + "'>";
                        b.addEventListener("click", function(e) {
                            inp.value = this.getElementsByTagName("input")[0].value;
                            atualizarReceituario();
                            closeAllLists();
                        });
                        a.appendChild(b);
                    }
                }
            });

            inp.addEventListener("keydown", function(e) {
                let x = document.getElementById(this.id + "autocomplete-list");
                if (x) x = x.getElementsByTagName("div");
                if (e.keyCode == 40) {
                    currentFocus++;
                    addActive(x);
                } else if (e.keyCode == 38) {
                    currentFocus--;
                    addActive(x);
                } else if (e.keyCode == 13) {
                    e.preventDefault();
                    if (currentFocus > -1) {
                        if (x) x[currentFocus].click();
                    }
                }
            });

            function addActive(x) {
                if (!x) return false;
                removeActive(x);
                if (currentFocus >= x.length) currentFocus = 0;
                if (currentFocus < 0) currentFocus = (x.length - 1);
                x[currentFocus].classList.add("autocomplete-active");
            }

            function removeActive(x) {
                for (let i = 0; i < x.length; i++) {
                    x[i].classList.remove("autocomplete-active");
                }
            }

            function closeAllLists(elmnt) {
                const x = document.getElementsByClassName("autocomplete-items");
                for (let i = 0; i < x.length; i++) {
                    if (elmnt != x[i] && elmnt != inp) {
                        x[i].parentNode.removeChild(x[i]);
                    }
                }
            }

            document.addEventListener("click", function (e) {
                closeAllLists(e.target);
            });
        }

        autocomplete(document.getElementById("nomePaciente"), nomesPacientes);

        function adicionarMedicamentoDoDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            const selectedOption = dropdown.options[dropdown.selectedIndex];
            if (!selectedOption || !selectedOption.value) {
                alert("Por favor, selecione um medicamento na lista.");
                return;
            }
            const nome = selectedOption.value;
            const posologia = selectedOption.dataset.posologia;
            adicionarMedicamento(nome, posologia);
            dropdown.selectedIndex = 0;
        }

        function adicionarMedicamento(nome, posologia) {
            const textarea = document.getElementById('prescricao');
            const textoAtual = textarea.value;
            const prefixo = textoAtual.trim() ? '\n' : '';
            const proximoItem = (textoAtual.match(/^\d+\./gm) || []).length + 1;
            const novaLinha = `${prefixo}${proximoItem}. ${nome}\n   Uso Oral: ${posologia}`;
            textarea.value += novaLinha;
            textarea.dispatchEvent(new Event('input'));
            atualizarReceituario();
            textarea.focus();
            textarea.scrollTop = textarea.scrollHeight;
        }

        let medicoSelecionado = null;
        function abrirModalMedicos() { document.getElementById('modalMedicos').style.display = 'block'; }
        function fecharModalMedicos() { document.getElementById('modalMedicos').style.display = 'none'; }

        function selecionarMedico(nome, crm, element) {
            document.getElementById('nomeMedico').value = nome;
            document.getElementById('crm').value = crm;
            document.querySelectorAll('.medico-card').forEach(card => card.classList.remove('selected'));
            element.classList.add('selected');
            fecharModalMedicos();
            atualizarReceituario();
        }

        window.onclick = function(event) {
            if (event.target === document.getElementById('modalMedicos')) {
                fecharModalMedicos();
            }
        }
        
        document.getElementById('prescricao').addEventListener('input', function() {
            const contador = document.getElementById('contadorCaracteres');
            const limite = 1000;
            contador.textContent = `${this.value.length}/${limite} caracteres`;
            contador.style.color = this.value.length > limite ? '#e74c3c' : (this.value.length > limite * 0.9 ? '#f39c12' : '#7f8c8d');
        });
        
        function validarCampos() {
            const nomePaciente = document.getElementById('nomePaciente').value.trim();
            const prescricao = document.getElementById('prescricao').value.trim();
            const nomeMedico = document.getElementById('nomeMedico').value.trim();
            const validacaoDiv = document.getElementById('validacao');
            let mensagens = [];
            if (!nomePaciente) mensagens.push('O nome do paciente é obrigatório.');
            if (!prescricao) mensagens.push('A prescrição médica é obrigatória.');
            if (!nomeMedico) mensagens.push('É necessário selecionar um médico.');
            if (mensagens.length > 0) {
                validacaoDiv.innerHTML = `<div class="validacao erro">${mensagens.join('<br>')}</div>`;
                return false;
            }
            validacaoDiv.innerHTML = '';
            return true;
        }

        function atualizarReceituario() {
            const nomePaciente = document.getElementById('nomePaciente').value;
            const prescricao = document.getElementById('prescricao').value;
            const nomeMedico = document.getElementById('nomeMedico').value;
            const crm = document.getElementById('crm').value;
            const dataAtual = new Date().toLocaleDateString('pt-BR');
            const placeholder = '[Prescrição médica será exibida aqui]';
            
            document.getElementById('displayNome').textContent = nomePaciente || '_______________________';
            document.getElementById('displayData').textContent = dataAtual;
            document.getElementById('displayPrescricao').textContent = prescricao || placeholder;
            document.getElementById('displayMedico').textContent = nomeMedico || 'ASSINATURA E CARIMBO DO MÉDICO';
            document.getElementById('displayCrm').textContent = crm || '______';
            
            document.getElementById('displayNome2').textContent = nomePaciente || '_______________________';
            document.getElementById('displayData2').textContent = dataAtual;
            document.getElementById('displayPrescricao2').textContent = prescricao || placeholder;
            document.getElementById('displayMedico2').textContent = nomeMedico || 'ASSINATURA E CARIMBO DO MÉDICO';
            document.getElementById('displayCrm2').textContent = crm || '______';
        }

        function imprimirReceituario() {
            if (validarCampos()) {
                window.print();
            }
        }

        function salvarRascunho() {
            if (!validarCampos()) {
                 document.getElementById('validacao').innerHTML = `<div class="validacao aviso">Preencha os campos obrigatórios antes de salvar.</div>`;
                 return;
            }
            const rascunhoSalvo = {
                nomePaciente: document.getElementById('nomePaciente').value,
                prescricao: document.getElementById('prescricao').value,
                nomeMedico: document.getElementById('nomeMedico').value,
                crm: document.getElementById('crm').value
            };
            localStorage.setItem('rascunhoReceita', JSON.stringify(rascunhoSalvo));
            document.getElementById('validacao').innerHTML = '<div class="validacao sucesso">Rascunho salvo com sucesso!</div>';
        }

        function carregarRascunho() {
            const rascunho = JSON.parse(localStorage.getItem('rascunhoReceita'));
            if (rascunho) {
                document.getElementById('nomePaciente').value = rascunho.nomePaciente || '';
                document.getElementById('prescricao').value = rascunho.prescricao || '';
                document.getElementById('nomeMedico').value = rascunho.nomeMedico || '';
                document.getElementById('crm').value = rascunho.crm || '';
                
                atualizarReceituario();
                document.getElementById('prescricao').dispatchEvent(new Event('input'));
                document.getElementById('validacao').innerHTML = '<div class="validacao sucesso">Rascunho carregado.</div>';
            } else {
                document.getElementById('validacao').innerHTML = '<div class="validacao aviso">Nenhum rascunho encontrado.</div>';
            }
        }

        function limparFormulario() {
            if (confirm('Tem certeza que deseja limpar todos os campos?')) {
                document.getElementById('nomePaciente').value = '';
                document.getElementById('prescricao').value = '';
                document.getElementById('nomeMedico').value = '';
                document.getElementById('crm').value = '';
                document.querySelectorAll('.medico-card').forEach(card => card.classList.remove('selected'));
                atualizarReceituario();
                document.getElementById('prescricao').dispatchEvent(new Event('input'));
                document.getElementById('validacao').innerHTML = '<div class="validacao aviso">Formulário limpo.</div>';
                abrirModalMedicos();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // *** ALTERAÇÃO ADICIONADA AQUI ***
            // Adiciona um "ouvinte" para atualizar o nome do paciente em tempo real.
            document.getElementById('nomePaciente').addEventListener('input', atualizarReceituario);

            let medicoCarregado = false;
            const rascunhoString = localStorage.getItem('rascunhoReceita');
            if (rascunhoString) {
                const rascunho = JSON.parse(rascunhoString);
                if (rascunho && rascunho.nomeMedico) {
                    medicoCarregado = true;
                }
                carregarRascunho();
            }
            if (!medicoCarregado) {
                abrirModalMedicos();
            }
        }); /* ADICIONAR SCRIPT DO GOOGLE PLANILHAS, PARA REGISTRAR CADA SAIDA DE RECEITA*/
    </script>
</body>
</html> 
